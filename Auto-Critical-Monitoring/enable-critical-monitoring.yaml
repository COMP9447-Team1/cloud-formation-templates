AWSTemplateFormatVersion: "2010-09-09"
Resources:

  StopEC2Instance:
    Type: "AWS::Lambda::Function"
    Properties:
      Description: "Stopping an EC2 instance"
      Handler: "index.lambda_handler"
      Code: 
        S3Bucket: !Join 
          - "remediation-lambdas-"
          - !Ref 'AWS::AccountId'
        S3Key: "{{INSERT_ZIPFILE_NAME}}"
      Role:
        Fn::GetAtt: 
          - LambdaExecutionRoleStopEC2Instance
          - Arn
      Runtime: "python3.8"

  EC2BlockIPAddress:
    Type: "AWS::Lambda::Function"
    Properties:
      Description: "Blocking an EC2 IP address"
      Handler: "index.lambda_handler"
      Code: 
        S3Bucket: !Join 
          - "remediation-lambdas-"
          - !Ref 'AWS::AccountId'
        S3Key: "{{INSERT_ZIPFILE_NAME}}"
      Role:
        Fn::GetAtt: 
          - LambdaExecutionRoleEC2BlockIPAddress
          - Arn
      Runtime: "python3.8"

  LambdaExecutionRoleEC2BlockIPAddress:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /service-role/
      ManagedPolicyArns: 
      - !Ref BasicEC2BlockIPAddress

  BasicEC2BlockIPAddress:
    Type: 'AWS::IAM::ManagedPolicy'
      Properties:
        Description: Managed policy for blocing an ec2 instance iP address
        Path: /
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: logs:CreateLogGroup
              Resource: !Join
                - ''
                - 'arn:aws:logs:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':*'
            - Effect: Allow
              Action:
              - logs:CreateLogStream
              - logs:PutLogEvents
              Resource: !Join
                - ''
                - 'arn:aws:logs:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':log-group:/aws/lambda/EC2BlockIPAddress:*'

  LambdaExecutionRoleStopEC2Instance:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /service-role/
      ManagedPolicyArns: 
        - !Ref BasicStopEC2InstanceRole
        - !Ref InlineStopEC2InstanceRole

  BasicStopEC2InstanceRole:
    Type: 'AWS::IAM::ManagedPolicy'
      Properties:
        Description: Managed policy for stopping an ec2 instance
        Path: /
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: logs:CreateLogGroup
              Resource: !Join
                = ''
                - 'arn:aws:logs:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':*'
            - Effect: Allow
              Action:
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: !Join
                = ''
                - 'arn:aws:logs:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':log-group:/aws/lambda/StopEC2Instance:*'

  InlineStopEC2InstanceRole:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action: ec2:StopInstances
            Resource: "*"

